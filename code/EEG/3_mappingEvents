%% 3. Batch EEG Event Mapping for TST Data Using Logfiles

% Author: Røskva
% Date: 09.05.25
% Last updated: 18.12.25

% Workflow context:
%   1. Preprocess EEG + ICA (Script 1)
%   2. Manually reject components (Script 2)
%   3. Run this script to map logfiles onto EEG event markers
%   4. Epoch & analyze (Script 4)

% TODO additions after basic mapping works:
% - map congruent vs incongruent from `string`
% - map repeat vs switch using `taskSwitch`
% - map correct/error using `correctResponse`
% - include response key (left/right/none)
% - verify S2/S3 alignment across blocks

% PURPOSE:
%   The cleaned EEG files contain only basic triggers (S  1, S  2, S  3, etc.).
%   The corresponding logfiles contain full trial metadata:
%       - trial index
%       - switch/repeat
%       - stimulus identity
%       - correctness
%       - reaction time
%       - response key

%   This script links those two sources. For each EEG S2/S3 stimulus event,
%   we assign new descriptive labels—e.g.:
%       'Stim1_R_cC'  (Stim1, repeat, current correct)
%       'Stim2_S_cE'  (Stim2, switch, current error)

% OUTPUT:
%   - Saves a new dataset: <base_name>_mapped.set
%   - Adds fields to EEG.event:
%         .trialNr
%         .taskSwitch
%         .correct
%         .key
%         .rt
%         .mappedType    (string label)

% the event types in the EEG file are :
% 'S  1' = newblock. Marks the time of a new block
% 'S  2' = stimulus one. Marks when stimulus one is displayed
% 'S  3' = stimulus two. Marks when stimulus two is displayed
% 'S  4' = error. Marks time of an incorrect response
% 'S  5' = correct. Marks time of a correct response 
% 'S254' = trigger in the beginning of block to align EEG
% 'boundary' = ?

% IMPORTANT: THERE'S 2 SPACES BETWEEN 'S' AND THE 'NUMBER' IN EEG FILE TRIGGERS. 

% Logic and descriptons of recoding
% 'R/S'             - repeat or switch trial 
% 'cC/cE'           - current correct response or current error response
% 'pC/pE'           - previous correct response or previous error response
% 'Stim1/Stim2'     - marks when stimulus one/two is displayed
% 'stim/res'        - moment of stimulus presentation or moment of response giving
% 'Firsttrial'      - first trial of a new block 


%% 0. Paths and file lists
addpath('\\hypatia.uio.no\lh-sv-psi\MICC\Projects\MindTheSleep\Code\tools\eeglab2025.0.0\');
eeglab;

clean_folder = '\\hypatia.uio.no\lh-sv-psi\MICC\Projects\MindTheSleep\Projects\Røskva\Data\TST\2_cleaned\';
log_folder   = '\\hypatia.uio.no\lh-sv-psi\MICC\Projects\MindTheSleep\Projects\Røskva\Data\TST\logfiles\';
out_folder   = '\\hypatia.uio.no\lh-sv-psi\MICC\Projects\MindTheSleep\Projects\Røskva\Data\TST\3_mapped\';

clean_files = dir(fullfile(clean_folder, '*_cleaned.set'));

for f = 1:length(clean_files)

    %% 1. Load EEG dataset
    filename = clean_files(f).name;
    [~, base_name, ~] = fileparts(filename);  % e.g., 'TST_191_1_cleaned'

    disp(['Mapping events for: ' base_name]);

    EEG = pop_loadset('filename', filename, 'filepath', clean_folder);

    % Extract subject/run number from base_name (TST_xxx_y_cleaned)
    tokens = regexp(base_name, 'TST_(\d+)_(\d+)', 'tokens');
    subjID = tokens{1}{1};
    runNr  = tokens{1}{2};

    %% 2. Load corresponding logfile (.mat)
    logFile = fullfile(log_folder, [subjID '_' runNr '.mat']);

    if ~exist(logFile, 'file')
        warning(['Missing logfile for: ' base_name]);
        continue;
    end

    logData = load(logFile);
    trials  = logData.testData.trial;  % struct array

    %% 3. Extract EEG event latencies for S2/S3
    isStim = strcmp({EEG.event.type}, 'S  2') | strcmp({EEG.event.type}, 'S  3');
    stimIdx = find(isStim);

    % simple safety check
    if length(stimIdx) ~= length(trials)
        warning(['Stimulus count mismatch: EEG=' num2str(length(stimIdx)) ...
                 ' log=' num2str(length(trials)) ' | ' base_name]);
        % We may refine matching later, but for now assume alignment.
    end

    %% 4. Loop through stimulus events and assign metadata
    for t = 1:min(length(stimIdx), length(trials))

        e = stimIdx(t);
        tr = trials(t);

        % basic info
        EEG.event(e).trialNr     = tr.trial;
        EEG.event(e).taskSwitch  = tr.taskSwitch;
        EEG.event(e).correct     = tr.correctResponse;
        EEG.event(e).key         = tr.keyPressed;
        EEG.event(e).rt          = tr.reactionTime;

        % create a compact mapping string
        % R/S = repeat/switch
        if tr.taskSwitch == 1
            rs = 'S';
        else
            rs = 'R';
        end

        if tr.correctResponse == 1
            cc = 'cC';
        else
            cc = 'cE';
        end

        % label uses existing EEG.event.type ('S  2' or 'S  3')
        stimType = strrep(EEG.event(e).type, ' ', ''); % remove spaces: 'S2'/'S3'

        EEG.event(e).mappedType = [stimType '_' rs '_' cc];

        % overwrite event.type for user-friendly epoching
        EEG.event(e).type = EEG.event(e).mappedType;

    end

    %% 5. Save mapped set
    out_name = [base_name '_mapped.set'];
    pop_saveset(EEG, 'filename', out_name, 'filepath', out_folder);

    disp(['SUCCESS: mapped & saved ' out_name]);

end

disp('Event mapping complete.');

